# Описание прототипа

1. Пользователи могут публиковать посты (операция `publish "author" "permlink"`)
2. Пользователи могут голосовать за посты (операции `vote "user" "author" "permlink"`)
   - vote - голосование оплачивается зарядом батарейки (внутренний ресурс)
   - vote2 - голосование оплачивается со счета пользователя (в размере 0.0001 SYS)
   - vote3 - голосование оплачивается с депозитного счета пользователя (который
             входит в состав приложения в размере 0.0001 SYS)
   - vote4 - голосование оплачивается с внутреннего в приложении счета пользователя
             (в размере 0.0001 SYS)
3. Через 30 секунд авторам выплачиваются награды из пула вознаграждения. В соответствии
   с набранным числом голосов. Пул наград - это отдельный аккаунт **geos.reward**.
   В некоторых случаях возможно разместить пул наград в аккаунте приложения.
   Наполнение пула наград выполняется за рамками данного приложения.
4. Выполнение операций publish & vote пользователи самостоятельно могут разрешить
   с огранниченным authority (posting).

Для упрощения прототипа контракт вестинга не реализовывался, а использовался системный
контракт cyber.token. Данное упрощение допустимо, так как операция "начислить вестинг"
схожа с операцией перевода средств в части проверки прав.


Подключение пользователя **user1** к приложению:
1. Создать пользователя
   ```
   cleos create key
   cleos system newaccount --stake-net '10.0000 SYS' --stake-cpu '10.0000 SYS' --buy-ram '10.0000 SYS' eosio geos <public-key>
   ```
2. Разрешить выполнять операции с posting-authority (по желанию пользователя)
   ```
   cleos create key
   cleos set account permission user1 posting "<public-key>" active
   cleos set action permission user1 geos "" posting
   ```

Размещение автором **alice** поста (считается, что для работы с приложением **alice**
настроила posting-authority):
```
cleos push action geos publish '["alice","permlink"]' -p alice@posting
```

## Различные варианты голосования

### Оплата только зарядом батарейки (внутренний ресурс)
Установка приложения включает в себя следующие действия:
1. Создать аккаунт для приложения **geos**
```
cleos system newaccount --stake-net '10.0000 SYS' --stake-cpu '10.0000 SYS' --buy-ram '10.0000 SYS' eosio geos EOS5JdtfvVxsx5YS5YQBnUoTdLxYNe5ghDXRYDdDfsAmoQw7FgGFn
```

2. Загрузить контракт приложения (contracts/auth-proto/media):
```
cleos set contract geos <path-to-media-contract>
```

3. Сформировать пул наград
Пул наград авторов может хранится как на счету аккаунта **geos**, так и не стороннем
счету. Во втором случае необходимо дать разрешение на вывод средств пользователю
**geos@eosio.code**. Пополнение пула наград выполняется переводом средств на счет
пула наград. Для создания пула наград на отдельном счету требутеся выполнить:
```
cleos system newaccount --stake-net '10.0000 SYS' --stake-cpu '10.0000 SYS' --buy-ram '10.0000 SYS' eosio geos.reward EOS7C1BchkfSm7SHz17ZwrKoUtCgP967rssmqbPJYEvv1JMfLoCWM
echo '{
    "threshold":1,
    "keys":[
        {"weight":1,"key":"EOS7C1BchkfSm7SHz17ZwrKoUtCgP967rssmqbPJYEvv1JMfLoCWM"}
    ],
    "accounts":[
        {"weight":1,"permission":{"actor":"geos","permission":"eosio.code"}}
    ]
}' >geos.reward.perm
cleos set account permission geos.reward active geos.reward.perm owner
```

4. Перевести средства в пул наград
```
cleos transfer eosio geos.reward '0.0010 SYS'
```

Пользователю для выполнения действия требуется ("платные" действия отсутствуют):
1. Выполнить действие:
   ```
   cleos push action geos vote '["user1","alice","plink"]' -p user1@posting
   ```


### Оплата со счета пользователя
Минусы:
- пользователь должен дать приложению право выполнять переводы средств

Установка приложения включает в себя следующие действия:
1. Создать аккаунт для приложения **geos**
2. Загрузить контракт приложения

Пул наград как в первом варианте.

Пользователю для выполнения "платного" действия требуется:
1. Дать права на выполнение перевода приложению **geos@eosio.code**. Самый безопасный
   для пользователя вариант заключается в использовании выделенного authority для
   выполнения переводов от имени приложения (в смарт-контракте должна указываться
   данная authority):
   - создать authority **trx**
   ```
   cleos set account permission user2 trx '{"threshold":1,"keys":[],"accounts":[
       {"weight":1,"permission":{"actor":"geos","permission":"eosio.code"}}]}' active
   ```
   - разрешить перевод средств с минимальной authority **trx**
   ```
   cleos set action permission cyber.token transfer trx
   ```
2. Перевести средства на свой счет (выполняется любым доступным пользователю способом)
3. Выполнить действие в приложении (контракт **geos**)
   ```
   cleos push action geos vote2 '["user2","alice","plink"]' -p user2
   ```

### Оплата с депозита пользователя
Плюсы:
- пользователь переводит средства самостоятельно (на свой "депозитный счет")
- код по хранению средств пользователей находится в одном месте (контракт депозит)

Минусы:
- появляется второй аккаунт для хранения депозитов пользователей
- хуже интеграция при сложной логике оплаты действий
- требуется загружать и поддерживать два контракта (приложения и депозита)

Установка приложения включает в себя следующие действия:
1. Создать аккаунт для хранения депозитов пользователей **geos.deposit**
2. Загрузить контракт депозитов (contracts/auth-proto/deposit)
3. Создать аккаунт для приложения **geos**
4. Загрузить контракт приложения
5. Указать в настройках приложения с какого депозита тратить средства пользователя
   (сейчас прописан в коде **geos.deposit**)
6. Для аккаунта **geos.deposit** указать, что active-authority могут получить
   **geos.deposit@eosio.code** и **geos@eosio.code**
   ```
   cleos set account permission geos.deposit active '{"limit":1,"keys":[...],
      "accounts":[{"weight":1,"permission":{"actor":"geos","permission":"eosio.code"}},
                  {"weight":1,"permission":{"actor":"geos.deposit","permission":"eosio.code"}}]}' owner
   ```

Пул наград как в первом варианте.

Пользователю для выполнения "платного" действия требуется:
1. Перевести средства на счет пользователя **geos.deposit** (через контракт cyber.token)
2. Выполнить действие в приложении (контракт **geos**)
   ```
   cleos push action geos vote3 '["user3","alice","plink"]' -p user3
   ```

Пользователь может получить количество средств на его аккаунте в приложении:
```
cleos get table geos.deposit user3 balance
```



### Оплата с внутреннего счета пользователя
В данном случае пул наград хранится на выделенном аккаунте.
Плюсы:
- пользователь переводит средства самостоятельно (на аккаунт приложения)
- лучше интеграция с логикой биллинга
- выглядит логичнее со стороны пользователя

Минусы:
- код по хранению средств пользователей дублируется в каждом приложении

Особенности:
- пул наград на выделенном счете

Установка приложения включает в себя следующие действия:
1. Создать аккаунт для хранения пула наград **geos.reward**
2. Создать контракт приложения **geos**
3. Загрузить контракт приложения
4. Указать в настройках приложения с какого аккаунта выплачивать награды
5. Разрешить перевод средств из пула наград **geos.reward** пользователю **geos@eosio.code**

Пользователю для выполнения "платного" действия требуется:
1. Перевести средства на счет приложения **geos** (через контракт cyber.token)
2. Выполнить действие в приложении (контракт **geos**)
   ```
   cleos push action geos vote4 '["user4","alice","plink"]' -p user4
   ```

Пользователь может получить количество средств на его аккаунте в приложении:
```
cleos get table geos user4 balance
```
